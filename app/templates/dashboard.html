<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <script>
        let refreshInterval = {{ refresh_interval }} * 1000;

        // Функция для обновления страницы
        function autoRefresh() {
            if (refreshInterval > 0) {
                setTimeout(() => {
                    location.reload();
                }, refreshInterval);
            }
        }

        // Устанавливаем начальный интервал обновления
        autoRefresh();

        // Функция для обновления интервала через AJAX
        function updateRefreshInterval(interval) {
            fetch('/set_refresh_interval', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({refresh_interval: interval})
            }).then(response => response.json())
            .then(data => {
                if (data.refresh_interval !== undefined) {
                    refreshInterval = data.refresh_interval * 1000;
                    autoRefresh();
                }
            }).catch(error => console.error('Error updating interval:', error));
        }
    </script>
</head>
<body>
    <h1>Dashboard</h1>
    <p>Total Users: {{ total_users }}</p>
    <p>Total Orders: {{ total_orders }}</p>
    <p>Total Orders Amount: {{ total_orders_amount }}</p>

    <!-- Управление интервалом автообновления -->
    <h2>Refresh Interval</h2>
    <select onchange="updateRefreshInterval(this.value)">
        <option value="0" {% if refresh_interval == 0 %}selected{% endif %}>No Auto-Refresh</option>
        <option value="10" {% if refresh_interval == 10 %}selected{% endif %}>10 Seconds</option>
        <option value="15" {% if refresh_interval == 15 %}selected{% endif %}>15 Seconds</option>
        <option value="30" {% if refresh_interval == 30 %}selected{% endif %}>30 Seconds</option>
        <option value="60" {% if refresh_interval == 60 %}selected{% endif %}>1 Minute</option>
    </select>
    <div class="container">
        <table class="orders-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Email пользователя</th>
                    <th>Сумма</th>
                    <th>Адрес</th>
                    <th>Дата</th>
                    <th>Состав заказа</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <tr>
                    <td>{{ order.id }}</td>
                    <td>{{ order.user.email }}</td>
                    <td>{{ order.total_amount }} руб.</td>
                    <td>{{ order.address }}</td>
                    <td>{{ order.created_at }}</td>
                    <td>
                        <ul>
                            {% for item in order.products %}
                            <li>
                                <img src="{{ url_for('static', filename=item.img) }}" alt="{{ item.name }}" style="width: 50px; height: 50px;">
                                id: {{ item.id }} — {{ item.name }} ({{ item.quantity }} шт.)
                            </li>
                            {% endfor %}
                        </ul>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</body>
</html>
